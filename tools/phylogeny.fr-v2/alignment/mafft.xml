<tool id="mafft1" name="MAFFT" version="7.205">
    <description>Multiple sequence alignment software</description>
    <requirements>
        <requirement type="package" version="7.205">mafft</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" level="fatal" description="Error occurred. Please check Tool Standard Error" />
        <exit_code range=":-1" level="fatal" description="Error occurred. Please check Tool Standard Error" />
    </stdio>
    <version_command>
        <![CDATA[ mafft --version ]]>
    </version_command>
    <command>
        <![CDATA[
            mafft
            
            ##Do not report progress
            --quiet
         
            ## specify threads to use
            --thread \${GALAXY_SLOTS:-1}
            
            $adjustdir
            
            #if $getTree.value == True
                --treeout
            #end if
            
            $datatype
            
            #if $matrix_condition.use_matrix == True :
                
                #if $matrix_condition.matrix_selected.matrix == "PAM":
                     --jtt ${matrix_condition.matrix_selected.PAM}
                #else        
                     --bl ${matrix_condition.matrix_selected.matrix}
                #end if
            #end if
            
            #if $method_condition.choice == "custom" :
                --$method_condition.distance_method
                --ep $ep
                --maxiterate $maxiterate
                
            #else:
                $method_condition.alignmentM
            #end if
            
            --op $op
            
            $reorder
            
            $outputFormat.value
         
            $inputSequences > $outputAlignment
   
            ;
            
            #if $getTree.value == True:
                mv ${inputSequences}.tree $outputTree;
            #end if
        ]]>
    </command>
    <inputs>
        <param name="inputSequences" format="fasta" type="data" label="Source file" help="Fasta sequence file"/>
        <param name="datatype" type="select" label="Data type">
             <option value="">Auto detection</option>
             <option value="--nuc">Nucleic acids</option>
             <option value="--amino">Amino acids</option>
        </param>
        <conditional name="matrix_condition">
            <param name="use_matrix" type="boolean" truevalue="true" falsevalue="false" checked="False" 
                   label="Use matrix ?" help="Usefull only for amino acids"/>
            <when value="true">
                <conditional name="matrix_selected">
                    <param name="matrix" type="select" label="Matrix" >
                        <option value="30">BLOSUM 30</option>
                        <option value="45">BLOSUM 45</option>
                        <option value="62" selected="true">BLOSUM 62</option>
                        <option value="80">BLOSUM 80</option>
                        <option value="PAM">PAM</option>
                    </param>
                    <when value="PAM">
                        <param name="PAM" type="integer" value="80" min="1" max="350" label="Coefficient of the PAM matrix"/>                      
                    </when>
                </conditional>
             </when>
        </conditional>
        
        <conditional name="method_condition">
            <param name="choice" type="select" label="Methods" help="Accuracy-oriented methods recommended for maximum 200 sequences" >
                <option value="speed">Speed-oriented methods</option>
                <option value="accuracy">Accuracy-oriented methods</option>
                <option value="custom">Choice your algorithm and params</option>
            </param>
            <when value="speed">
                <param name="alignmentM" type="select" display="radio" label="Alignment methods">
                    <option value="--retree 2 --maxiterate 1000">FFT-NS-i (iterative refinement method; max. 1000 iterations)</option>
                    <option value="--retree 2 --maxiterate 0" selected="true">FFT-NS-2 (fast; progressive method)</option>
                    <option value="--retree 1 --maxiterate 0">FFT-NS-1 (very fast; recommended for >2000 sequences)</option>
                    <option value="--retree 2 --maxiterate 2 --nofft">NW-NS-i (iterative refinement method without FFT approximation; two cycles only )</option>
                    <option value="--retree 2 --maxiterate 0 --nofft">NW-NS-2 (fast; progressive method without the FFT approximation)</option>
                    <option value="--retree 1 --maxiterate 0 --nofft --parttree">NW-NS-PartTree-1 (recommended for ~10,000 to ~50,000 sequences)</option>
                </param>
            </when>
            <when value="accuracy">
               <param name="alignmentM" type="select" display="radio" label="Alignment methods">
                   <option value="--localpair --maxiterate 1000" >L-INS-i (probably most accurate)</option>
                   <option value="--globalpair --maxiterate 1000">G-INS-i (suitable for sequences of similar lengths)</option>
                   <option value="--genafpair --maxiterate 1000 --ep=0">E-INS-i (suitable for sequences containing large unalignable regions)</option>
               </param>
            </when>
            <when value="custom">
                <param type="select" name="distance_method" display="radio" label="Distance method" help="Distance method must be chosen regarding your data">
                    <option value="6merpair" selected="true">Shared 6mers distance (fastest)</option>
                    <option value="globalpair">Global alignment (NW)</option>
                    <option value="localpair">Local alignment (SW)</option>
                    <option value="genafpair">Local, affine gap cost</option>
                    <option value="fastapair">FASTA distance</option>
                </param> 
                <param name="ep" type="float" value="0.123" label="Gap extend penalty" help="0.123 default value"/> 
                <param name="iterations" type="integer" value="1" min="1" max="1000" label="Maximum number of iterations" help="1000 for maximum quality"/>
            </when>
        </conditional>
        
        <param name="op" type="float" value="1.53" label="Gap opening penalty" help="1.53 default value"/>         
        <param name="adjustdir" type="boolean" truevalue="--adjustdirection" falsevalue="" checked="False" label="Adjust direction?" />
        <param name="getTree" type="boolean" truevalue="true" falsevalue="false" checked="False" label="Display alignment tree ?"/>
        <param name="reorder" type="boolean" truevalue="--reorder" falsevalue="" checked="False" label="Reorder output?"/>
        
        <param name="outputFormat" type="select" label="Output format" help="Either FASTA or ClustalW">
            <option value="" selected="true">FASTA</option>
            <option value="--clustalout">ClustalW</option>
            <option value="--phylipout">Phylip</option>
        </param>
    </inputs>
    
    <outputs>
        <data name="outputAlignment" format="fasta" label="${tool.name} Alignment">
            <change_format>
                <when input="outputFormat" value="--clustalout" format="clustal"/>
                <when input="outputFormat" value="--phylipout" format="phylip"/>
            </change_format>
        </data>
        <data name="outputTree" format="txt" label="${tool.name} Guide Tree">
            <filter>getTree == True </filter>
        </data>  
    </outputs>
    <tests>
        <test>
            <param name="inputSequences" value="sample.fa"/>
            <param name="flavourType" value="mafft-fftns"/>
            <param name="outputFormat" value="fasta"/>
            <output name="outputFasta" ftype="fasta" file="mafft_fftns_result.aln"/>
        </test>
        <test>
            <param name="inputSequences" value="sample.fa"/>
            <param name="flavourType" value="mafft-nwns"/>
            <param name="outputFormat" value="clustalw"/>
            <output name="outputClustalW" ftype="clustal" file="mafft_nwns_result.aln"/>
        </test>
    </tests>
    <help>
       <![CDATA[

.. class:: infomark

**MAFFT version 7.205 **

-----

**What it does**

MAFFT is a multiple sequence alignment program for unix-like operating systems.  
It offers a range of multiple alignment methods, L-INS-i (accurate; for alignment of <∼200 sequences), 
FFT-NS-2 (fast; for alignment of <∼30,000 sequences), etc.

From the MAFFT man page, an overview of the different predefined flavours of the tool.

**Accuracy-oriented methods:**

- L-INS-i (probably most accurate; recommended for <200 sequences; iterative refinement method incorporating local pairwise alignment information):
    
    - mafft --localpair --maxiterate 1000 input [> output]

- G-INS-i (suitable for sequences of similar lengths; recommended for <200 sequences; iterative refinement method incorporating global pairwise alignment information):
    
    - mafft --globalpair --maxiterate 1000 input [> output]

- E-INS-i (suitable for sequences containing large unalignable regions; recommended for <200 sequences):
    
    - mafft --ep 0 --genafpair --maxiterate 1000 input [> output]. For E-INS-i, the --ep 0 option is recommended to allow large gaps. 


**Speed-oriented methods:**

- FFT-NS-i (iterative refinement method; two cycles only):

    - mafft --retree 2 --maxiterate 2 input [> output]

- FFT-NS-i (iterative refinement method; max. 1000 iterations):

    - mafft --retree 2 --maxiterate 1000 input [> output]

- FFT-NS-2 (fast; progressive method):

    - mafft --retree 2 --maxiterate 0 input [> output]

- FFT-NS-1 (very fast; recommended for >2000 sequences; progressive method with a rough guide tree):

    - mafft --retree 1 --maxiterate 0 input [> output]

- NW-NS-i (iterative refinement method without FFT approximation; two cycles only):

    - mafft --retree 2 --maxiterate 2 --nofft input [> output]

- NW-NS-2 (fast; progressive method without the FFT approximation):

    - mafft --retree 2 --maxiterate 0 --nofft input [> output]

- NW-NS-PartTree-1 (recommended for ~10,000 to ~50,000 sequences; progressive method with the PartTree algorithm):

    - mafft --retree 1 --maxiterate 0 --nofft --parttree input [> output]

**Options:**

--auto
    Automatically selects an appropriate strategy from L-INS-i, FFT-NS-i and FFT-NS-2, according to data size. Default: off (always FFT-NS-2)
--adjustdirection
    Generate reverse complement sequences, as necessary, and align them together with the remaining sequences. In the case of protein alignment, these options are just ignored.
  
--op
    Gap opening penalty, default: 1.53
--ep
    Offset (works like gap extension penalty), default: 0.0
--maxiterate
    Maximum number of iterative refinement, default: 0
--clustalout
    Output: clustal format, default: fasta
--thread
    Number of threads (if unsure, --thread -1)

-----

==============
 Please cite: 
==============

"Parallelization_ of the MAFFT multiple sequence alignment program."


.. _Parallelization: http://bioinformatics.oxfordjournals.org/content/26/15/1899.long

**Katoh, Toh**

Bioinformatics 26:1899-1900, 2010. (describes the multithread version; Linux only)


"Multiple_ Alignment of DNA Sequences with MAFFT."


.. _Multiple: http://mbe.oxfordjournals.org/content/early/2013/02/08/molbev.mst010.full

**Katoh, Asimenos, Toh**

Methods in Molecular Biology 537:39-64, 2009. (outlines DNA alignment methods and several tips including group-to-group alignment and rough clustering of a large number of sequences)


"Improved_ accuracy of multiple ncRNA alignment by incorporating structural information into a MAFFT-based framework."


.. _Improved: http://www.biomedcentral.com/1471-2105/9/212

**Katoh, Toh**

BMC Bioinformatics 9:212, 2008. (describes RNA structural alignment methods)


"Recent_ developments in the MAFFT multiple sequence alignment program."


.. _Recent: http://bib.oxfordjournals.org/content/9/4/286.abstract

**Katoh, Toh**

Briefings in Bioinformatics 9:286-298, 2008. (outlines version 6; Fast Breaking Paper in Thomson Reuters' ScienceWatch)


"PartTree_: an algorithm to build an approximate tree from a large number of unaligned sequences." 


.. _PartTree: http://bioinformatics.oxfordjournals.org/content/23/3/372.abstract

**Katoh, Toh**

Bioinformatics 23:372-374, Errata, 2007. (describes the PartTree algorithm)


"MAFFT version 5: improvement_ in accuracy of multiple sequence alignment."


.. _improvement: http://nar.oxfordjournals.org/content/33/2/511.abstract

**Katoh, Kuma, Toh, Miyata**

Nucleic Acids Res. 33:511-518, 2005. (describes [ancestral versions of] the G-INS-i, L-INS-i and E-INS-i strategies)


"MAFFT: a novel method_ for rapid multiple sequence alignment based on fast Fourier transform."


.. _method: http://nar.oxfordjournals.org/content/30/14/3059.full

**Katoh, Misawa, Kuma, Miyata**

Nucleic Acids Res. 30:3059-3066, 2002.
 

-----    
    
==========
 Overview
==========    

MAFFT is a multiple sequence alignment program for unix-like operating systems. It offers a range of multiple alignment methods, L-INS-i wich is accurate for alignment with less than 200 sequences, FFT-NS-2 which is fast for alignment with less than 10000 sequences. 

-----

For further informations, please visite the MAFFT_ website.

.. _MAFFT: http://mafft.cbrc.jp/alignment/software/
         ]]>
    </help>
    <citations>
        <citation type="doi">10.1093/molbev/mst010</citation> 
    </citations>
</tool>
