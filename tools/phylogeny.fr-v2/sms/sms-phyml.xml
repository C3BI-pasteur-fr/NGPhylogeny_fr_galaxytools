<tool id="sms-phyml" name="SMS-PHYML" version="1.2">
	<description>maximum likelihood-based inference of phylogenetic trees</description>
    <requirements>
        <requirement type="package" version="3.0">phyml</requirement>
    </requirements>
	<command>
                bash sms.sh 
                -i $input
                -o $output_models.files_path
   		-p	
   		#if $sequence.seqtype == "auto" :
                     ## Automatic sequence detection
                     ## read an info file to choose which option set 
                     #set $info = open( str($input_info) ).read()
                     #if 'dna' in $info:
                            -d nt
                     #else if 'protein' in $info:
                            -d aa
                     #end if
                #else :
                    -d $sequence.seqtype
                #end if
   		-c $stat_crit
				
                #if $inpuTree.inputtree == "true" :
                    -u $inpuTree.userInpuTree
                #end if    
		-s $move
	
		#if $support_condition.support == "sh":
		    -b -4
		#else if $support_condition.support == "aBayes":
		    -b -5
		#else if $support_condition.support == "no":
		    -b 0
		#else if $support_condition.support == "boot":
		    -b $support_condition.boot_number
		#end if
		#if $randstart.value != "":
		    -r $randstart
		#end if
		> $output_stdout
		;
		mv ${output_models.files_path}/mtest.phy_phyml_tree.txt $output_tree;
		mv ${output_models.files_path}/mtest.phy_phyml_stats.txt $output_stats;
		mv ${output_models.files_path}/smsout.csv $output_models;
   	</command>
	<inputs>
		<param format="phylip" name="input" type="data" label="Alignment file" help="phylip format"/>
		<conditional name="sequence">
			<param name="seqtype" type="select" label="Data type">
				<option value="nt">Nucleic acids</option>
				<option value="aa">Amino acids</option>
				<option value="auto">Auto</option>
			</param>
			<when value="nt" />
			<when value="aa" />
			<when value="auto">
				<param name="input_info" type="data" format="txt" label="info"
					help="Precompute file containning sequence description (dna or protein)" />
			</when>
		</conditional>   
		<param name="stat_crit" type="select" label="Statistical criterion to select the model">
				<option value="aic">AIC</option>
				<option value="bic">BIC</option>
		</param>
		<param name="move" type="select" label="Tree topology search" display="radio">
			<option value="NNI">NNI (Nearest Neighbor Interchange)</option>
			<option value="SPR">SPR (Subtree Pruning and Regraphing)</option>
			<option value="BEST">Best of NNI and SPR</option>
		</param>
   		<conditional name="support_condition">
   			<param type="select" name="support" label="Branch support" help="Use aLRT or aBayes to save computing time">
				<option value="sh">SH-like aLRT</option>
				<option value="aBayes">aBayes</option>
				<option value="boot">Bootstrap</option>
				<option value="no">No branch support</option>
			</param>  
			<when value="sh"/>
			<when value="aBayes"/>
			<when value="boot">
				<param type="integer" name="boot_number" min="1" value="100" label="Number of bootstrap replicates" help="Must be a positive integer"/>
			</when>
			<when value="no"/>
		</conditional>
               <conditional name="inpuTree">
                   <param name="inputtree" type="boolean" truevalue="true" falsevalue="false" checked="False" label="Use input starting tree" />
                   <when value="true">
                       <param name="userInpuTree" type="data" label="Tree file" help="newick format"/>
                   </when>
                   <when value="false"/>
               </conditional>
               <param type="text" name="randstart" value="" label="Number of random starting trees" />
	</inputs>
	<outputs>
		<data format="txt" name="output_tree" label="PhyML Newick tree"/>
		<data format="txt" name="output_stats" label="PhyML Statistics"/>
		<data format="txt" name="output_stdout" label="PhyML Stdout"/>
		<data format="txt" name="output_models" label="SMS compare models"/>
	</outputs>
	<help>

.. class:: infomark

**Program encapsulated in Galaxy by Southgreen**
**Encapsulation improved by ATGC (C. Vernette, V. Lefort)**

.. class:: infomark

 This script runs SMS to select a model and PhyML with this selected model
 Command example : ./sms.sh -p -i in.phy -o smsdir/ -d aa -c aic -s NNI -b 0
SMS options :
     -p = Whithout this option the script only runs SMS
     -i = Input alignement file in Phylip format**Mandatory**
     -o = Outputs directory
     -d = Data type : 'aa' or 'nt' **Mandatory**
     -c = Statistical criterion to select the model : 'aic' (default) or 'bic'
     -u = Input starting tree (Newick format)
PhyML options :
     -s = Type of tree improvement : 'NNI (default)' or 'SPR'
     -r = Number of random starting trees
     -b = Branch Support : >0 for bootstraps, -4 for aLRT

**PhyML version 3.1, 2010**

-----

==============
 Please cite: 
==============

"New algorithms and methods to estimate maximum-likelihood phylogenies_: assessing the performance of PhyML 3.0"


.. _phylogenies: http://sysbio.oxfordjournals.org/content/59/3/307.long

**Guindon S., Dufayard JF., Anisimova M., Hordijk W., Lefort V., Gascuel O.**

Systematic Biology 2010 59(3):307-321; doi:10.1093/sysbio/syq010. 


"A simple, fast, and accurate algorithm to estimate large phylogenies by maximum likelihood_."


.. _likelihood: http://sysbio.oxfordjournals.org/content/52/5/696.full.pdf+html 

**Guindon S., Gascuel O.**

Systematic Biology, 52(5):696-704, 2003.

-----

===========
 Overview:
===========

PhyML is a phylogeny software based on the maximum-likelihood principle. Early PhyML versions used a fast algorithm to perform Nearest Neighbor Interchanges (NNIs), in order to improve a reasonable starting tree topology. Since the original publication (Guindon and Gascuel 2003), PhyML has been widely used due to its simplicity and a fair accuracy/speed compromise. In the mean time research around PhyML has continued. 

We designed an efficient algorithm to search the tree space using Subtree Pruning and Regrafting (SPR) topological moves (Hordijk and Gascuel 2005), and proposed a fast branch test based on an approximate likelihood ratio test (Anisimova and Gascuel 2006). However, these novelties were not included in the official version of PhyML, and we found that improvements were still needed in order to make them effective in some practical cases. PhyML 3.0 achieves this task. 

It implements new algorithms to search the space of tree topologies with user-defined intensity. A non-parametric, Shimodaira-Hasegawa-like branch test is also available. The program provides a number of new evolutionary models and its interface was entirely re-designed. We tested PhyML 3.0 on a large collection of real data sets to ensure that the new version is stable, ready-to-use and still reasonably fast and accurate. 

-----

For further informations, please visite the PhyML_ website.


.. _PhyML: http://www.atgc-montpellier.fr/phyml/
	</help>

</tool>
