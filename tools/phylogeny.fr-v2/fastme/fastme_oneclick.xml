<tool id="fastme" name="FastME" version="2.1.4.1">
	<description>Distance-based inference of phylogenetic trees</description>
	<requirements>
        <requirement type="package" version="2.1.4">fastme</requirement>
    </requirements>
    <version_command>
        <![CDATA[ fastme --version ]]>
    </version_command>
    <stdio>
        <exit_code range="1:" level="fatal" />
    </stdio>
	<command>fastme --input_data=$input 
					--output_tree=$outputTree 
					--output_matrix=$outputMatrix
                    --output_info=$outputLog
                    --nb_threads=\${GALAXY_SLOTS:-1}
                    
					#if $bootChoice.boot =="true":
						--output_info=$outputBoostrap
						--bootstrap=$bootChoice.replicates
					#end if
						
					#if $typeChoice.datatype =="d":
						--dna=$typeChoice.modeldna
						
					#else if $typeChoice.datatype =="p":
						--protein=$typeChoice.modelprot
						
				    #else:
		                 ## Read information of sequence type:
			             ## read an info file to choose which option set and set a model by default
			             #set $info = open( str($input_info) ).read()
			             #if 'dna' in $info:
			                    --dna=T
			             #else if 'protein' in $info:
			                   --protein=L
			             #end if
				    
					#end if
		
					#if $gammaChoice.gamma == "true":
						--gamma=$gammaChoice.rate
					#end if
					
					--method=$distance
					
					--branch_length=B
					
					$equilibrium
					$removeGap
					$NNI
					$SPR;
	</command>

	<inputs>
		<param name="input" type="data" format="phylip" label="Phylip input"/>
		<param name="fileout_label" type="text" value="Newick tree" label="Output name" help="Output name for files" />
		<conditional name="typeChoice">
			<param name="datatype" type="select"  label="Data type" >
				<option value="d">DNA</option>
				<option value="p">Protein</option>
				<option value="auto">Specified in a file</option>
			</param>
			<when value="d">
				<param name="modeldna" type="select" label="Evolutionary model">
					<option value="4">F84</option>
					<option value="R">RY</option>
					<option value="1">F81</option>
					<option value="J">JC69</option>
					<option value="K">K2P</option>
					<option value="T">TN93</option>
					<option value="p">p-distance</option>
				</param>
			</when>
			<when value="p">
				<param name="modelprot" type="select" label="Evolutionary model">
					<option value="L">LG</option>
					<option value="W">WAG</option>
					<option value="J">JTT</option>
					<option value="h">Day off</option>
					<option value="C">CpRev</option>
					<option value="D">DCMut</option>
					<option value="b">HIVb</option>
					<option value="I">HIVw</option>
					<option value="M">MtREV</option>
					<option value="R">RtREV</option>					
					<option value="p">p-distance</option>					
				</param>			
			</when>
			<when value="auto">
			     <param name="input_info" format="txt" type="data" multiple="false" label="sequence type info" help="Precompute file containning sequence description (dna or protein)"/>
			</when>
		</conditional>
		<param name="equilibrium" type="boolean" label="Equilibrium frequencies" truevalue="--equilibrium" falsevalue="" help="By default, frequencies are globally counted from the nucleotides alignment or defined by the proteic substitution model. By checking the box, frequencies are pairwise estimated by counting the nucleotides or estimated by counting the amino-acids in the alignment."/>
		<conditional name="gammaChoice">
			<param name="gamma" type="select" label="Gamma distributed rates across sites">
				<option value="true">Yes</option>
				<option value="false">No</option>
			</param>
			<when value="true">
				<param name="rate" type="float" label="Gamma distribution parameter" value="1" min="0"/>
			</when>
			<when value="false">
			</when>
		</conditional>
		<param name="removeGap" type="boolean" label="Remove all sites containing gap" truevalue="--remove_gap" falsevalue=""/>
		<param name="distance" type="select" label="Distance algorithm">
			<option value="I">BIONJ</option>
			<option value="B">TaxAdd BalME</option>
            <option value="O">TaxAdd LSME</option>
			<option value="N">NJ</option>
			<option value="U">UNJ</option>
		</param>
		<param name="NNI" type="select" display="radio" label="Tree swapping NNI" help='Nearest Neighbor Interchanges'>
		    <option value="">No NNI move</option>
			<option value="--nni=B">Balanced NNI</option>
			<option value="--nni=O">OLS NNI</option>
		</param>
		<param name="SPR" type="boolean" label="Tree swapping SPR" truevalue="--spr" falsevalue="" checked="true" help="Subtree Pruning and Regraft"/>
		<conditional name="bootChoice">
			<param name="boot" type="boolean" label="Bootstrap" truevalue="true" falsevalue="false" checked="false"/>
			<when value="true">
				<param name="replicates" type="text" value="100" label="Number of replicatess"/>
			</when>
			<when value="false">
			</when>
		</conditional>
	</inputs>
	<outputs>
		<data name="outputTree" format="nwk" label="${fileout_label}"/>
		<data name="outputLog" format="txt" label="FastME Information"/>
		<data name="outputBoostrap" format="nwk" label="FastME Bootstrap trees">
			<filter>bootChoice['boot'] == "true"</filter>
		</data>
		<data name="outputMatrix" format="txt" label="FastME Distance matrix"/>
	</outputs>
    <tests>
        <test>
         <param name="input" value="phylip" />
            <param name="modeldna" value="4"/>
            <param name="distance" value="I"/>
            <output name="outputTree" file="newick" />
        </test>
        <test>
            <param name="input" value="phylip" />
            <param name="modeldna" value="T"/>
            <param name="distance" value="I"/>
            <param name="SPR" value="--spr"/>
            <param name="fileout_label" value="tree_mT_dI_spr.nwk" />
            <output name="outputTree" file="tree_mT_dI_spr.nwk" />            
        </test>
    </tests>
	<help>

.. class:: infomark


**FastME version 2.1.4**


.. class:: infomark


**Galaxy integration** Andres Gwendoline, Institut FranÃ§ais de Bioinformatique.
**Support** For any questions about Galaxy integration, please send an e-mail to support.abims@sb-roscoff.fr


-----
	

======
FastMe
======

-----------
Description
-----------


    FastME - A distance based phylogeny reconstruction algorithm.

    FastME showed better topological accuracy than NJ,
    BIONJ, WEIGHBOR and FITCH, in all evolutionary
    conditions we tested, which include large range
    deviations from molecular clock and substitution rates.
    
    FastME first builds an initial tree, using either OLS_GME, balanced_GME, NJ or BIONJ algorithms, 
    and then improves this tree by tree swapping, using either OLS_NNI or balanced_NNI algorithms.
    OLS_GME and OLS_NNI optimize the ordinary least-squares (OLS) version of the minimum-evolution principle,
    while balanced_GME and balanced_NNI optimize the balanced version.




-----------------
Workflow position
-----------------

**Upstream tools**

=========== ========================== =======
Name            output file(s)         format 
=========== ========================== =======
Readseq     phylip conversion          phylip 
=========== ========================== =======


**Downstream tools**

=========== ========================== =======
Name            output file(s)         format
=========== ========================== =======
Rooting     out tree                   Newick 
=========== ========================== =======


----------
Input file
----------

Phylip file 
    Phylip file with sequence alignments
    

----------
Parameters
----------

Output name
        Output base name for the ouput files

Evolutionary model
    Indicate the evolutionary [model] which can be choosen from:p-distance, RY symmetric, RY, JC69, K2P, F81, F84 (default), TN93, LogDet.

Distance method
    FastME computes a tree using a distance algorithm. You may choose this method/topologie from: TaxAdd_BalME, TaxAdd_OLSME, BIONJ (default), NJ, UNJ, NNI_BalME, NNI_OLS or SPR

------------
Output files
------------

Output_name
    Resulting tree at Newick format 

Output_name.log
    Log file

------------
Dependencies
------------
FastME
    http://www.atgc-montpellier.fr/fastme
    


---------------------------------------------------

---------------
Working example
---------------

Input files
===========

Phylip file
-----------

::

    168 5125
    IRAT112      GAGAACCGTC CTGTAAGTAC TCTTGCTTTA AGTAATAAAG TAATACTAAT
    KARASUKARA   GAGAACCGTC CTGTAAGTAC TCTTGCTTTA AATACGAAAG TAATACTAAT

Parameters
==========

Output name -> Newick tree

Evolutionary model -> F84

Distance method -> BIONJ

Output files
============

Newick tree
-----------

::

    (((((((((((((((((((((((((GOGOLEMPUK:0.001198,GOGOLEMPAK:0.002128):0.030378,TREMBESE:0.013258):0.055246,(((JIMBRUKJOL:0.045219,KETANKONIR:0.035298):0.006267, ...
    

-----


OPTIONS
=======

    -i input data file, --input_data=input data file
        The input data file contains sequence alignment(s)
        or a distance matrix(ces).

    -u input user tree file, --user_tree=input user tree file
        FastME may use an existing topology available in the input user tree file
        which corresponds to the input dataset.

    -o output tree file, --output_tree=output tree file
        FastME will write the infered tree into the output tree file.

    -O output matrix file, --output_matrix=output matrix file
        Use this option if you want FastME to write the distances
        matrix computed from the input alignment in the output matrix file.

    -I output information file, --output_info=output information file
        Use this option if you want FastME to write information
        about its execution in the output information file.

    -B output bootstrap trees file, --output_boot=output bootstrap trees file
        Use this option if you want FastME to write bootstrap trees
        in the bootstrap trees file.

    -a, --append
        Use this option to append results to existing output files (if any).
        By default output files will be overwritten.

    -m method, --method=method
        FastME computes a tree using a distance algorithm.
        You may choose this method from:
        TaxAdd_(B)alME, TaxAdd_(O)LSME, B(I)ONJ (default),
        (N)J or (U)NJ.

    -d[model], --dna=[model]
        Use this option if your input data file contains DNA sequences alignment(s).
        You may also indicate the evolutionary [model] which can be choosen from:
        (p)-distance, R(Y) symmetric, (R)Y, (J)C69, (K)2P, F8(1), F8(4) (default), (T)N93, (L)ogDet.

    -p[model], --protein=[model]
        Use this option if your input data file contains protein sequences alignment(s).
        You may also indicate the evolutionary [model] which can be choosen from:
        (p)-distance, (F)81 like, (L)G (default), (W)AG, (J)TT, Day(h)off, 
        (D)CMut, (C)pRev, (M)tREV, (R)tREV, HIV(b), H(I)Vw or FL(U).

    -r, --remove_gap
        Use this option to completely remove any site which has a gap in
        any sequence. By default, FastME is doing pairwise deletion of gaps.

    -e, --equilibrium
        The equilibrium frequencies for DNA are always estimated by counting
        the occurence of the nucleotides in the input alignment.
        For amino-acid sequences, the equilibrium frequencies are estimated
        using the frequencies defined by the substitution model.
        Use this option if you whish to estimate the amino-acid frequencies
        by counting their occurence in the input alignment.

    -g[alpha], --gamma=[alpha]
        Use this option if you wish to have gamma distributed rates across sites.
        By default, FastME runs with no gamma variation.
        If running FastME with gamma distributed rates across sites, the [alpha] default value is 1.0.
        Only helpful when the input data file contains sequences alignment(s).

    -n[NNI], --nni=[NNI]
        Use this option to do [NNI] tree topology improvement.
        You may choose the [NNI] type from:
        NNI_(B)alME (default) or NNI_(O)LS.

    -s, --spr
        Use this option to do SPR tree topology improvement.

    -w branch, --branch_length=branch
        Use this option to indicate the branch length to assign to the tree.
        You may choose the branch length from: (B)alLS (default), (O)LS
        or (n)one. (n)one is only available with BIONJ, NJ or UNJ.
        Only helpful when not improving the tree topology (no NNI nor SPR).

    -D datasets, --datasets=datasets
        Use this option to indicate the number of datasets in your input
        data file. Default value is 1.

    -b replicates, --bootstrap=replicates
        Use this option to indicate the number of replicates FastME will
        do for bootstrapping. Default value is 0.
        Only helpful when the input data file contains sequences alignment(s).

    -z seed, --seed=seed
        Use this option to initialize randomization with seed value.
        Only helpful when bootstrapping.

    -c
        Use this option if you want FastME only to compute distance matrix.
        Only helpful when the input data file contains sequences alignment(s).

    -T number of threads, --nb_threads=number of threads
        Use this option to set the number of threads to use.
        Default number of threads is 4.

    -v value, --verbose=value
        Sets the verbose level to value [0-3].
        Default value is 0.

    -V, --version
        Prints the FastME version.

    -h, --help
        Display this usage.



For further informations, please visite FastME_

.. _FastME: http://www.atgc-montpellier.fr/fastme/usersguide.php

	</help>
	<citations>
	   <citation type="doi">10.1093/molbev/msv150</citation>
       <citation type="doi">10.1089/106652702761034136</citation>
    </citations>
</tool>
